{% extends 'base.html' %}
{% block content %}
    <div class="pageholder">
        <div class="titleholder"> 
            <a class="ourbutton mr-2 ml-2" href="{% url 'home'%}"> To home</a>
            <div class="title"><i class="fa-solid fa-table"></i> Vivo Customer Dashboard </div> 
        </div>

        <div class="linkholder">
            <table id="ourtable2" class="beheertable dezetabel">
                <thead>
                    <tr>
                        <th>Customer Name</th>
                        <th>Shop Name</th>
                        <th>Sold Area</th>
                        <th>Phone Number</th>
                        <th>Phone Model</th>
                        <th>Sale Status</th>
                        <th>Prize Details</th>
                        <th>IMEI</th>
                        <th>Gift</th>
                        <th>Date of Purchase</th>
                        <th>How Know About Campaign</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="btn-group mt-3">
            <button id="filterAllCustomersButton" class="btn btn-custom mr-2">All Customers</button>
            <button id="filterWithGiftsButton" class="btn btn-custom mr-2">Customers with Gifts</button>
            <button id="filterWithoutGiftsButton" class="btn btn-custom mr-2">Customers without Gifts</button>
        </div>        
        <div class="btn-group mt-3">
            <button id="csvDownloadButton" class="btn btn-dark">
                <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
            </button>
        </div>
        
    </div>


<script  >
    var data = JSON.parse("{{data|escapejs}}");

    $(document).ready(function() {
        var table = $('#ourtable2').DataTable({
           data: data,
            "columns": [
                { "data": "customer_name" },
                { "data": "shop_name" },
                { "data": "sold_area" },
                { "data": "phone_number" },
                { "data": "phone_model" },
                { "data": "sale_status" },
                { "data": "prize_details" },
                { "data": "imei" },
                { "data": "gift__name" },
                { "data": "date_of_purchase" },
                { "data": "how_know_about_campaign" },
                ],
        });

                // Add event listeners for your filtering buttons
        $('#filterAllCustomersButton').on('click', function() {
            table.column(9).search('').draw();
        });

        $('#filterWithGiftsButton').on('click', function() {
            table.column(9).search('customers_with_gifts').draw();
        });

        $('#filterWithoutGiftsButton').on('click', function() {
            table.column(9).search('customers_without_gifts').draw();
        });


        $('#csvDownloadButton').on('click', function() {
            // Extract DataTable data and format it as CSV
            var csvData = '';

            // Get the header row
            var headerRow = table.columns().header().toArray();
            var headerData = headerRow.map(function(headerCell) {
                return headerCell.textContent;
            });
            csvData += headerData.join(',') + '\n';

            // Get the table data
            table.rows().every(function(rowIdx, tableLoop, rowLoop) {
                var rowData = this.data();
                var rowValues = Object.values(rowData);
                csvData += rowValues.join(',') + '\n';
            });

            // Create a Blob containing the CSV data
            var blob = new Blob([csvData], { type: 'text/csv;charset=utf-8' });

            // Create a temporary link element to trigger the download
            var a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = 'data.csv';
            a.style.display = 'none';
            document.body.appendChild(a);

            // Trigger the click event to download the CSV
            a.click();

            // Clean up
            document.body.removeChild(a);
        });
    });
</script>
{% endblock %}